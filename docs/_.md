# MKSAP Media Extraction Implementation Guide

## Project Overview
You are implementing a media extraction system for the ACP MKSAP (Medical Knowledge Self-Assessment Program) question bank. The system needs to extract all supplemental media files (images, tables, videos) associated with each valid question.

## System Architecture
### Current State

- Valid Questions: 2,198 (excluding 35 invalidated questions)

Question Distribution:
- MKSAP (mcq): 1,202 questions
- Visual Diagnosis (vdx): 459 questions
- CORE (cor): 288 questions
- Quick Questions (qqq): 249 questions


### Question ID Format
- [Specialty(2)][Type(3-4)][Year(2)][Sequence(2-3)]
Examples:
- cccor25002 = Critical Care, CORE, 2025, sequence #2
- cvmcq24086 = Cardiovascular, MCQ (MKSAP), 2024, sequence #86
- cvvdx24053 = Cardiovascular, Visual Diagnosis, 2024, sequence #53
- dmqqq24001 = Dermatology, Quick Question, 2024, sequence #1

### Question ID Array Mapping

- Questions are indexed sequentially from 0 to 2232 in the API
- Each array index maps to a unique question
- Access via /api/content_metadata.json -> questions object

### Available Media Types & Counts

1. Figures (Images) - 1,632 Total

- Formats: SVG, JPG, PNG
- Metadata Available: id, number, title, shortTitle, imageInfo (extension, dimensions)
- Examples: ccfig24605, dmfig24637
- Storage Location: content_metadata.json -> figures collection

2. Tables (HTML Content) - 773 Total

- Format: JSON content converted to HTML
- Metadata Available: id, title, shortTitle, jsonContent (full HTML structure), footnotes
- Examples: pmtab24040
- Storage Location: Embedded in question API responses under tablesContent

3. Videos (MP4) - 122 Total

- Format: MP4 video files
- Metadata Available: id, title, mp4Hash, dimensions, canonicalLocation
- Examples: ccvid24001, ccvid25002
- Storage Location: content_metadata.json -> videos collection

4. Audio Files - 0

- No audio files found in the system

### API Endpoints

#### Primary Endpoints

##### Content Metadata

- GET /api/content_metadata.json
- Returns: Complete system metadata including questions, figures, tables, videos, etc.
- Size: Large file (~15MB+)
- Contains: All question metadata, figure references, table definitions, video metadata

##### Individual Question Details

- GET /api/questions/{questionId}.json
- Example: /api/questions/pmmcq25001.json
- Returns: Full question structure with stimulus, exposition, tables, options

##### Highlights (Text Content References)

- GET /api/highlights.json
- Returns: Highlight/section content with IDs for cross-referencing

#### Question Data Structure

##### Full Question Response Format

```json
{
  "id": "pmmcq25001",
  "subspecialtyId": "pm",
  "correctAnswer": "A",
  "stimulus": {
    "0": {
      "type": "p",
      "hlId": "8ed1a1",
      "children": ["Text content..."]
    },
    "1": {
      "type": "inline-wrap",
      "contentIds": ["ccfig24605", "ccfig24606"]
    }
  },
  "prompt": "Question text...",
  "options": [
    {
      "letter": "A",
      "text": "Option A text"
    }
  ],
  "exposition": {
    "0": {
      "type": "p",
      "hlId": "41c34d",
      "children": ["Explanation content..."]
    }
  },
  "tablesContent": {
    "pmtab24040": {
      "id": "pmtab24040",
      "title": {"__html": "Table Title"},
      "jsonContent": {
        "tagName": "table",
        "children": [/* table structure */]
      }
    }
  },
  "hlIds": ["8ed1a1", "f78abf", ...],
  "references": ["reference1", "reference2"],
  "keypoints": ["keypoint1", "keypoint2"],
  "hospitalist": false,
  "hvc": false,
  "peerComparison": {...},
  "relatedSection": "pmsec24007_24004",
  "objective": {"__html": "Learning objective..."},
  "tags": [
    {"type": "product", "value": "mksap"},
    {"type": "venue", "value": "Ambulatory"}
  ]
}
```

##### Media Reference Mechanisms

1. Inline Content References (Most Common)

- Located in stimulus and exposition arrays:
```json
{
  "type": "inline-wrap",
  "contentIds": ["ccfig24605", "ccfig24606"]
}
```

- What to do: Look up each contentId in the figures collection
- Returns: Complete figure metadata including title, dimensions, image extension

2. Table References (Direct Embedding)

- Located in question.tablesContent:
```json
"tablesContent": {
  "pmtab24040": {
    "id": "pmtab24040",
    "title": {"__html": "..."},
    "shortTitle": {"__html": "..."},
    "jsonContent": {
      "tagName": "table",
      "children": [...]
    },
    "footnotes": [[...]],
    "canonicalLocation": "pmsec24007_24004"
  }
}

- What to do: Convert jsonContent structure to HTML table
- Returns: Complete table HTML with footnotes and legends
```

3. Video References

- Located in videos collection and matched via canonicalLocation:
```json
{
  "id": "ccvid24001",
  "canonicalLocation": "ccmcq24012",
  "title": "Lung Point on Point-of-Care Ultrasound",
  "mp4Hash": "[base64 encoded]",
  "height": 360,
  "width": 640
}
```
- What to do: Match video.canonicalLocation to question ID
- Returns: Video metadata and hash for URL construction

### Data Extraction Strategy

#### Approach 1: Pure API Method (Recommended for Speed)

##### Step 1: Fetch and Cache Content Metadata

1. Call GET /api/content_metadata.json
2. Extract and store:
   - questions = {qId: questionData, ...}
   - figures = {figId: figureData, ...}
   - tables = {tableId: tableData, ...}
   - videos = {videoId: videoData, ...}
3. Build lookup indexes:
   - questionById (fast access)
   - figureById (fast access)
   - videoByCanonicalLocation (for video matching)

#### Step 2: Process Each Question (2,198 iterations)
For each valid question (ID 0-2232, excluding 35 invalidated):
  1. Fetch /api/questions/{questionInternalId}.json
  2. Parse stimulus array for contentIds
  3. Parse exposition array for contentIds
  4. Collect all figure references from contentIds
  5. Extract tablesContent if present
  6. Match videos via question ID

##### Step 3: Output Structure

Output structure:
```json
{
    arrayId: 0,
    internalId: "cccor25002",
    subspecialty: "cc",
    product: "core",
    media: {
      figures: [
        {
          id: "ccfig24605",
          title: "...",
          extension: "svg",
          dimensions: {width: 227, height: 383},
          canonicalLocation: "ccsec24002_24001"
        }
      ],
      tables: [
        {
          id: "pmtab24040",
          title: "...",
          htmlContent: "<table>...</table>",
          footnotes: [...]
        }
      ],
      videos: [
        {
          id: "ccvid24001",
          title: "...",
          dimensions: {width: 640, height: 360}
        }
      ]
    },
    stimulus: {raw: [...], contentIds: [...]},
    exposition: {raw: [...], contentIds: [...]},
    options: [...],
    correctAnswer: "A"
  }
```
### Approach 2: Hybrid Method (Browser + API)

##### For Standard Extraction:
- Use API-only approach from Approach 1

##### For Image URL Discovery:
For questions with figures:
  1. Render question stimulus HTML in browser
  2. Wait for images to load
  3. Extract actual <img> src URLs from CloudFront
  4. Store URL pattern for batch downloading
  
Pattern to expect:
  https://d2chybfyz5ban.cloudfront.net/assets/[hash].[extension]

##### For Verification:
1. Use browser rendering only for sample questions
2. Verify that contentId lookup matches rendered images
3. Document any discrepancies

### Implementation Requirements

##### Data to Extract Per Question
For each valid question with image, table, video, or svg content, capture:

##### Question Metadata
- Array ID (0-2232)
- Internal ID (e.g., "cccor25002")
- Subspecialty (cc, cv, cs, dm, en, fc, gi, hm, hp, id, in, nr, np, on, pm, rm)
- Product type (core, mksap, vdx, qq)
- Correct answer (A, B, C, D)
- Tags (product type, venue, patient demographics)

##### Question Content
- Stimulus (raw structure and text)
- Prompt/Question text
- Options (all 4 answer choices with letters)
- Exposition/Explanation (full text)
- Key points (if present)
- References (if present)

##### Associated Media
- Figures: ID, title, extension, dimensions, canonical location
- Tables: ID, title, HTML content, footnotes, structure
- Videos: ID, title, dimensions, canonical location

##### Linkage Data
- hlIds (highlight cross-references)
- contentIds (figure/media references)
- relatedSection (textbook section reference)

##### Validation Requirements

Validate extracted data:
- All 2,198 questions have been processed
- No invalidated questions (35) are included
- Each figure reference resolves to actual figure metadata
- Each table reference has complete HTML structure
- Video references match to canonical locations
- No null/undefined critical fields

### Output Format Options

##### Option A: Single Comprehensive JSON
```json
{
  "metadata": {
    "extractionDate": "2025-12-26",
    "totalQuestionsExtracted": 2198,
    "totalFiguresReferenced": 1000+,
    "totalTablesReferenced": 200+,
    "totalVideosReferenced": 50+,
    "system": "MKSAP 19"
  },
  "questions": [
    {
      "arrayId": 0,
      "internalId": "cccor25002",
      "subspecialty": "cc",
      "product": "core",
      "stimulus": {...},
      "options": [...],
      "media": {...}
    }
  ],
  "figuresIndex": {
    "ccfig24605": {...}
  },
  "tablesIndex": {
    "pmtab24040": {...}
  }
}
```

#### Option B: Database-Ready Format
```json
{
  "questions": [...],
  "figures": [...],
  "tables": [...],
  "videos": [...]
}
```
- Table: questions (one row per question)
- Table: question_figures (junction table)
- Table: question_tables (junction table)
- Table: question_videos (junction table)
- Table: figures (complete figure metadata)
- Table: tables (complete table metadata)
- Table: videos (complete video metadata)

##### Option C: File-Based Structure
```json
{
  "questions": [...],
  "figures": [...],
  "tables": [...],
  "videos": [...]
}
```

```json
/questions/
  /{subspecialty}/
    /{questionId}.json
    /{questionId}_stimulus.html
    /{questionId}_exposition.html
/media/
  /figures/
    /{figureId}.json
    /{figureId}.svg
  /tables/
    /{tableId}.json
    /{tableId}.html
  /videos/
    /{videoId}.json
```

### Critical Findings

##### About Image Files

- Figure metadata includes imageInfo.hash but this is NOT a direct URL
- Actual image URLs are in CloudFront CDN and discovered via browser rendering
- Pattern: https://d2chybfyz5ban.cloudfront.net/assets/[identifier].[extension]
- May require selective browser rendering to obtain actual URLs

##### About Hyperlinks

- No external hyperlinks found in questions linking to media files
- All media references are internal via contentIds or canonical locations
- All media is served through MKSAP API and CDN

##### About Tables

- Tables are fully embedded in API responses as jsonContent
- No separate table files needed
- HTML structure available for direct conversion

##### About Videos

- 122 videos available in system
- Associated with ~50 questions via canonicalLocation
- May have mp4Hash for URL construction or direct download links

### Error Handling & Edge Cases

##### Handle These Scenarios:
    
- Questions with no media: ~1,000+ questions are text-only
- Multiple figures per question: Some questions reference 2-5 figures
- Missing figure references: Graceful handling if contentId not found in figures
- Invalid invalidated questions: Skip array IDs with invalidated=true flag
- Malformed jsonContent: Validate and sanitize table HTML structure
- Video without canonical location: Store with null questionId reference
- Base64 encoded hashes: Document how to handle/decode if needed

### Performance Considerations

##### Optimization Strategies:

- Caching: Fetch /api/content_metadata.json once and cache
- Batch Processing: Process questions in parallel (e.g., 10 concurrent requests)
- Database Indexing: Index by questionId, figureId, tableId for fast lookups
- Lazy Loading: For browser-based extraction, only render questions with media
- Rate Limiting: Respect server limits (typically 100-200 requests/minute)

##### Estimated Runtime:

API-Only Approach: 5-15 minutes (2,198 questions with parallel requests)
Hybrid with Browser: 30-60 minutes (depending on media count and rendering time)

### Success Criteria

##### Implementation is complete when:

- ✅ All valid questions extracted
- ✅ Invalidated questions excluded
- ✅ All figure contentIds resolved to figure metadata
- ✅ All table htmlContent captured
- ✅ All video references matched and captured
- ✅ Data validated and deduplicated
- ✅ Output in chosen format (JSON, database, files)
- ✅ Image URLs discovered (if required for download)
- ✅ Error log documenting any missing/invalid references
- ✅ Summary report with extraction statistics

### Testing Checklist

##### Before production run:

- Test with sample of 10 questions from each product type
- Verify figure lookup works for ccfig, cvfig, dmfig, etc.
- Verify table HTML conversion produces valid HTML
- Verify video canonical location matching works
- Test with questions that have 0, 1, 3, and 5+ figures
- Test with both 2024 and 2025 question years
- Validate no duplicate figures across multiple questions
- Check for memory leaks in batch processing
- Verify API response consistency across multiple calls
- Test error handling for network timeouts


### Appendix A: API Response Examples

#### Figure Metadata Structure

```json
{
  "id": "ccfig24605",
  "number": 24605,
  "title": "Key Components of Acute Respiratory Failure Assessment",
  "shortTitle": "Acute Respiratory Failure Assessment",
  "bookId": "cc",
  "canonicalLocation": "ccsec24002_24001",
  "imageInfo": {
    "extension": "svg",
    "vector": true,
    "width": 227,
    "height": 383,
    "hash": "[base64 encoded]"
  },
  "footnotes": ["[optional footnote text]"],
  "credits": ["[optional image credits]"]
}
```

#### Table Metadata Structure

```json
{
  "id": "pmtab24040",
  "title": {"__html": "Fleischner Society Recommendations for Solitary Subsolid Lung Nodule Follow-Up"},
  "shortTitle": {"__html": "Recommendations for Solitary Subsolid Lung Nodule Follow-Up"},
  "bookId": "pm",
  "canonicalLocation": "pmsec24007_24004",
  "jsonContent": {
    "tagName": "table",
    "type": "tag",
    "attrs": {"className": "..."},
    "children": [...]
  },
  "footnotes": [[...]],
  "updatedDate": "2025-02-03"
}
```

#### Video Metadata Structure

```json
{
  "id": "ccvid24001",
  "number": 24001,
  "title": "Lung Point on Point-of-Care Ultrasound",
  "shortTitle": "Lung Point on POCUS",
  "canonicalLocation": "ccmcq24012",
  "height": 360,
  "width": 640,
  "mp4Hash": "[base64 encoded]"
}
```
